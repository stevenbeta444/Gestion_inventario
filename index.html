<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario Agropiragua (Local) con Reportes</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome (for icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        /* Definición de colores base */
        body { background-color: #f8f9fa; }
        .dark body { background-color: #1f2937; } /* bg-gray-800 */

        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, background-color 0.3s, color 0.3s;
        }
        .bg-card { background-color: white; }
        .dark .bg-card { background-color: #374151; } /* gray-700 */

        .btn-primary {
            background-color: #10b981; /* Emerald 500 */
            border: none;
        }
        .btn-primary:hover {
            background-color: #059669; /* Emerald 600 */
        }
        .inventory-list::-webkit-scrollbar {
            width: 8px;
        }
        .inventory-list::-webkit-scrollbar-thumb {
            background-color: #d1d5db; /* Gray 300 */
            border-radius: 4px;
        }
        .dark .inventory-list::-webkit-scrollbar-thumb {
            background-color: #4b5563; /* Gray 600 */
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">

    <div id="app" class="min-h-screen p-4 sm:p-8">
        <!-- Header -->
        <header class="text-center mb-8 flex flex-col sm:flex-row justify-between items-center">
            <h1 class="text-3xl sm:text-5xl font-extrabold text-green-700 dark:text-green-400 tracking-tight flex items-center mb-4 sm:mb-0">
                <i class="fas fa-paw text-yellow-500 mr-2"></i> Agropiragua (Sistema Local)
            </h1>
            
            <div class="flex items-center space-x-4">
                <!-- Toggle Modo Oscuro -->
                <button id="dark-mode-toggle" class="p-2 rounded-full text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-300 shadow-md">
                    <i id="theme-icon" class="fas fa-sun w-5 h-5"></i>
                </button>
            </div>
        </header>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Columna Izquierda: Movimientos (Entrada/Salida) y Reportes -->
            <div class="lg:col-span-1 space-y-6">

                <!-- 1. Movimiento Form -->
                <div class="card bg-card p-6 rounded-xl">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4 flex items-center">
                        <i class="fas fa-truck-ramp-box mr-2 text-green-600 dark:text-green-400"></i> Registrar Movimiento
                    </h2>

                    <!-- Pestañas de Movimiento -->
                    <div class="flex mb-4 border-b border-gray-200 dark:border-gray-600">
                        <button id="tab-entrada" class="flex-1 py-2 text-sm font-medium border-b-2 transition-colors duration-200">
                            <i class="fas fa-plus mr-1"></i> Entrada
                        </button>
                        <button id="tab-salida" class="flex-1 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 dark:text-gray-400 hover:text-green-600 dark:hover:text-green-400 hover:border-green-300 dark:hover:border-green-400">
                            <i class="fas fa-minus mr-1"></i> Salida
                        </button>
                    </div>

                    <!-- Formulario de Movimiento -->
                    <form id="movement-form" class="space-y-4">
                        <input type="hidden" id="movement-type" value="entrada">

                        <div class="text-gray-700 dark:text-gray-300">
                            <label for="provider-select" class="block text-sm font-medium">Proveedor</label>
                            <select id="provider-select" required 
                                class="mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 shadow-sm focus:border-green-500 focus:ring-green-500 p-2 border bg-white">
                                <!-- Opciones cargadas por JS -->
                            </select>
                        </div>

                        <div class="text-gray-700 dark:text-gray-300">
                            <label for="product-select" class="block text-sm font-medium">Producto (Referencia)</label>
                            <select id="product-select" required 
                                class="mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 shadow-sm focus:border-green-500 focus:ring-green-500 p-2 border bg-white">
                                <!-- Opciones cargadas por JS -->
                            </select>
                        </div>

                        <div class="text-gray-700 dark:text-gray-300">
                            <label for="quantity-input" class="block text-sm font-medium">Cantidad</label>
                            <input type="number" id="quantity-input" required min="1" value="1" 
                                class="mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 shadow-sm focus:border-green-500 focus:ring-green-500 p-2 border bg-white">
                        </div>

                        <button type="submit" id="submit-button" class="w-full py-2 px-4 rounded-lg text-white font-semibold transition duration-150 btn-primary flex items-center justify-center">
                            <i class="fas fa-check mr-2"></i> Registrar Entrada
                        </button>
                    </form>

                    <!-- Mensaje de estado -->
                    <div id="message-box" class="mt-4 p-3 rounded-lg text-sm hidden"></div>
                </div>

                <!-- 2. Sección de Reportes/Exportación (NUEVA) -->
                <div class="card bg-card p-6 rounded-xl">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4 flex items-center">
                        <i class="fas fa-file-export mr-2 text-indigo-600 dark:text-indigo-400"></i> Reportes y Exportación
                    </h2>

                    <form id="export-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-gray-700 dark:text-gray-300">
                                <label for="start-date" class="block text-sm font-medium">Fecha de Inicio</label>
                                <input type="date" id="start-date" required
                                    class="mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border bg-white">
                            </div>
                            <div class="text-gray-700 dark:text-gray-300">
                                <label for="end-date" class="block text-sm font-medium">Fecha de Fin</label>
                                <input type="date" id="end-date" required
                                    class="mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border bg-white">
                            </div>
                        </div>

                        <button type="submit" id="export-button" class="w-full py-2 px-4 rounded-lg text-white font-semibold transition duration-150 bg-indigo-600 hover:bg-indigo-700 flex items-center justify-center">
                            <i class="fas fa-download mr-2"></i> Exportar a CSV (Rango de Fecha)
                        </button>
                    </form>

                    <!-- Mensaje de estado de exportación -->
                    <div id="export-message" class="mt-4 p-3 rounded-lg text-sm hidden"></div>
                </div>

            </div>

            <!-- Columna Derecha: Inventario en Tiempo Real -->
            <div class="lg:col-span-2">
                <div class="card bg-card p-6 rounded-xl">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4 flex items-center">
                        <i class="fas fa-warehouse mr-2 text-teal-600 dark:text-teal-400"></i> Inventario General
                        <span id="total-products" class="ml-auto text-xl font-extrabold text-teal-600 dark:text-teal-400">0</span>
                    </h2>

                    <!-- Filtros de Inventario -->
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <div class="flex-1 text-gray-700 dark:text-gray-300">
                            <label for="filter-provider" class="block text-xs font-medium uppercase">Filtrar por Proveedor</label>
                            <select id="filter-provider" 
                                class="mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 shadow-sm focus:border-teal-500 focus:ring-teal-500 p-2 border text-sm bg-white">
                                <option value="">Todos los Proveedores</option>
                                <!-- Opciones cargadas por JS -->
                            </select>
                        </div>
                        <div class="flex-1 text-gray-700 dark:text-gray-300">
                            <label for="filter-product" class="block text-xs font-medium uppercase">Buscar Producto</label>
                            <input type="text" id="filter-product" placeholder="Escribe para buscar..." 
                                class="mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 shadow-sm focus:border-teal-500 focus:ring-teal-500 p-2 border text-sm bg-white">
                        </div>
                    </div>

                    <!-- Lista de Inventario (Tabla Responsive) -->
                    <div class="overflow-x-auto">
                        <div id="inventory-list" class="inventory-list max-h-96 overflow-y-auto">
                            <!-- Headers de la tabla (solo visible en desktop) -->
                            <div id="table-headers" class="hidden sm:grid grid-cols-12 gap-4 py-2 px-4 text-xs font-semibold uppercase text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-600 rounded-t-lg sticky top-0 z-10 border-b border-gray-200 dark:border-gray-600">
                                <div class="col-span-4">Producto</div>
                                <div class="col-span-2">Proveedor</div>
                                <div class="col-span-3">Presentación</div>
                                <div class="col-span-3 text-right">Stock Actual</div>
                            </div>
                            
                            <div id="inventory-items" class="divide-y divide-gray-200 dark:divide-gray-600">
                                <!-- Los ítems del inventario se insertarán aquí por JS -->
                            </div>
                            <div id="no-results" class="hidden text-center p-8 text-gray-500 dark:text-gray-400">
                                No se encontraron productos con estos filtros.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- CONSTANTES DE LOCAL STORAGE ---
        const INVENTORY_KEY = 'agropiragua_inventory_local';
        const MOVEMENTS_KEY = 'agropiragua_movements_local'; // NUEVA CLAVE PARA HISTORIAL
        
        // --- DATA INICIAL (Estructura de Productos) ---
        const PRODUCTS_DATA = [
            // ITALCOL (Agility Gold, Chunky, Italcan)
            { id: 'AG-PC-1.5', name: 'AGILITY GOLD PEQUEÑOS CACHORROS', provider: 'ITALCOL', presentation: '1.5 KG', stock: 0 },
            { id: 'AG-GA-3', name: 'AGILITY GOLD GRANDES ADULTOS', provider: 'ITALCOL', presentation: '3 KG', stock: 0 },
            { id: 'CH-CP-2', name: 'CHUNKY CACHORROS POLLO', provider: 'ITALCOL', presentation: '2 KG', stock: 0 },
            { id: 'CH-AS-8', name: 'CHUNKY ADULTO SALMÓN Y CORDERO', provider: 'ITALCOL', presentation: '8 KG', stock: 0 },
            { id: 'IT-PRR-40', name: 'ITALCAN PLUS POLLO Y ARROZ', provider: 'ITALCOL', presentation: '40 KG', stock: 0 },
            
            // PURINA (Pro Plan, Dog Chow, Cat Chow)
            { id: 'PP-SAS-7.5', name: 'PRO PLAN ADULTO MEDIANO SALMON', provider: 'PURINA', presentation: '7.5 KG', stock: 0 },
            { id: 'PP-KS-1', name: 'PRO PLAN GATO ESTERILIZADO', provider: 'PURINA', presentation: '1 KG', stock: 0 },
            { id: 'DC-TPA-22.7', name: 'DOG CHOW TRIPLE PROTEIN ADULTOS', provider: 'PURINA', presentation: '22.7 KG', stock: 0 },
            { id: 'CC-AC-15', name: 'CAT CHOW ADULTOS CARNE', provider: 'PURINA', presentation: '15 KG', stock: 0 },
            { id: 'PP-VET-GI-2', name: 'PRO PLAN VETERINARY GASTROINTESTINAL', provider: 'PURINA', presentation: '2 KG', stock: 0 },

            // ALIMENTOS LA POLAR (Super Can, Dogourmet)
            { id: 'SP-AE-15', name: 'SUPER CAN ADULTO ECONÓMICO', provider: 'ALIMENTOS LA POLAR', presentation: '15 KG', stock: 0 },
            { id: 'DG-CP-1', name: 'DOGOURMET CACHORROS POLLO', provider: 'ALIMENTOS LA POLAR', presentation: '1 KG', stock: 0 },
            { id: 'SP-MA-25', name: 'SUPER CAN MAX ADULTOS', provider: 'ALIMENTOS LA POLAR', presentation: '25 KG', stock: 0 },
        ].sort((a, b) => a.name.localeCompare(b.name)); // Ordenar productos al inicio

        // --- REFERENCIAS DE DOM ---
        const DOMElements = {
            html: document.documentElement,
            darkModeToggle: document.getElementById('dark-mode-toggle'),
            themeIcon: document.getElementById('theme-icon'),
            providerSelect: document.getElementById('provider-select'),
            productSelect: document.getElementById('product-select'),
            filterProvider: document.getElementById('filter-provider'),
            filterProduct: document.getElementById('filter-product'),
            quantityInput: document.getElementById('quantity-input'),
            movementForm: document.getElementById('movement-form'),
            movementTypeInput: document.getElementById('movement-type'),
            submitButton: document.getElementById('submit-button'),
            messageBox: document.getElementById('message-box'),
            inventoryItems: document.getElementById('inventory-items'),
            noResults: document.getElementById('no-results'),
            tabEntrada: document.getElementById('tab-entrada'),
            tabSalida: document.getElementById('tab-salida'),
            totalProducts: document.getElementById('total-products'),
            tableHeaders: document.getElementById('table-headers'),
            // Nuevos elementos para exportación
            exportForm: document.getElementById('export-form'),
            startDateInput: document.getElementById('start-date'),
            endDateInput: document.getElementById('end-date'),
            exportMessage: document.getElementById('export-message'),
        };

        let currentInventory = [];
        let movementHistory = []; // NUEVO: Historial de movimientos

        // --- GESTIÓN DE LOCAL STORAGE (Base de Datos Local) ---

        /**
         * Carga el inventario y el historial desde localStorage.
         */
        function initializeData() {
            // Inicializar Inventario
            const storedInventory = localStorage.getItem(INVENTORY_KEY);
            if (storedInventory) {
                try {
                    currentInventory = JSON.parse(storedInventory);
                } catch (e) {
                    console.error("Error al parsear el inventario. Reestableciendo.", e);
                    currentInventory = [...PRODUCTS_DATA];
                    saveInventory();
                }
            } else {
                currentInventory = [...PRODUCTS_DATA];
                saveInventory();
            }

            // Inicializar Historial de Movimientos
            const storedMovements = localStorage.getItem(MOVEMENTS_KEY);
            if (storedMovements) {
                try {
                    movementHistory = JSON.parse(storedMovements);
                } catch (e) {
                    console.error("Error al parsear el historial de movimientos. Reestableciendo.", e);
                    movementHistory = [];
                    saveMovements();
                }
            } else {
                movementHistory = [];
            }
        }

        /**
         * Guarda el inventario actual.
         */
        function saveInventory() {
            try {
                localStorage.setItem(INVENTORY_KEY, JSON.stringify(currentInventory));
            } catch (e) {
                console.error("Error al guardar el inventario.", e);
                showMessage('Error crítico: No se pudo guardar el inventario localmente.', 'error');
            }
        }

        /**
         * Guarda el historial de movimientos.
         */
        function saveMovements() {
            try {
                localStorage.setItem(MOVEMENTS_KEY, JSON.stringify(movementHistory));
            } catch (e) {
                console.error("Error al guardar el historial de movimientos.", e);
                showMessage('Error crítico: No se pudo guardar el historial de movimientos localmente.', 'error');
            }
        }

        // --- GESTIÓN DEL MODO OSCURO (Mantenido) ---
        function initializeDarkMode() {
            const isDark = localStorage.getItem('darkMode') === 'true';
            if (isDark) {
                DOMElements.html.classList.add('dark');
                DOMElements.themeIcon.classList.replace('fa-sun', 'fa-moon');
            } else {
                DOMElements.html.classList.remove('dark');
                DOMElements.themeIcon.classList.replace('fa-moon', 'fa-sun');
            }
        }

        function toggleDarkMode() {
            const isCurrentlyDark = DOMElements.html.classList.contains('dark');
            if (isCurrentlyDark) {
                DOMElements.html.classList.remove('dark');
                DOMElements.themeIcon.classList.replace('fa-moon', 'fa-sun');
                localStorage.setItem('darkMode', 'false');
            } else {
                DOMElements.html.classList.add('dark');
                DOMElements.themeIcon.classList.replace('fa-sun', 'fa-moon');
                localStorage.setItem('darkMode', 'true');
            }
        }

        // --- GESTIÓN DE SELECTORES (Mantenido) ---
        function populateSelectors() {
            const providers = [...new Set(PRODUCTS_DATA.map(p => p.provider))].sort();

            const populate = (selectElement) => {
                selectElement.innerHTML = selectElement === DOMElements.filterProvider ? '<option value="">Todos los Proveedores</option>' : '';
                providers.forEach(provider => {
                    const option = document.createElement('option');
                    option.value = provider;
                    option.textContent = provider;
                    selectElement.appendChild(option);
                });
            };

            populate(DOMElements.providerSelect);
            populate(DOMElements.filterProvider);
            
            if (providers.length > 0) {
                updateProductSelector(providers[0]);
            }
            
            DOMElements.providerSelect.addEventListener('change', (e) => {
                updateProductSelector(e.target.value);
            });
        }

        function updateProductSelector(selectedProvider) {
            const filteredProducts = PRODUCTS_DATA.filter(p => p.provider === selectedProvider);
            DOMElements.productSelect.innerHTML = '';
            
            if (filteredProducts.length === 0) {
                const option = document.createElement('option');
                option.textContent = 'No hay productos para este proveedor';
                DOMElements.productSelect.appendChild(option);
                DOMElements.productSelect.disabled = true;
                return;
            }

            DOMElements.productSelect.disabled = false;
            filteredProducts.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.name} (${product.presentation}) - Ref: ${product.id}`;
                DOMElements.productSelect.appendChild(option);
            });
        }

        // --- GESTIÓN DE MOVIMIENTOS (Actualizada para registrar historial) ---
        function registerMovement(e) {
            e.preventDefault();
            
            const productId = DOMElements.productSelect.value;
            const movementType = DOMElements.movementTypeInput.value;
            let quantity = parseInt(DOMElements.quantityInput.value, 10);
            
            if (!productId || isNaN(quantity) || quantity <= 0) {
                showMessage('Error: Selecciona un producto e ingresa una cantidad válida.', 'error');
                return;
            }

            const itemIndex = currentInventory.findIndex(item => item.id === productId);
            if (itemIndex === -1) {
                showMessage('Error: Producto no encontrado.', 'error');
                return;
            }

            const isEntry = movementType === 'entrada';
            let newStock;

            // 1. Lógica de Stock
            if (isEntry) {
                newStock = currentInventory[itemIndex].stock + quantity;
            } else {
                if (currentInventory[itemIndex].stock < quantity) {
                    showMessage(`Error de Stock: Solo hay ${currentInventory[itemIndex].stock} unidades de ${productId} en stock.`, 'error');
                    return;
                }
                newStock = currentInventory[itemIndex].stock - quantity;
            }

            // 2. Registrar en Historial de Movimientos
            const productDetails = PRODUCTS_DATA.find(p => p.id === productId);
            const movementRecord = {
                date: new Date().toISOString(), // Fecha y hora ISO para fácil filtrado
                type: movementType,
                quantity: quantity,
                productId: productId,
                productName: productDetails.name,
                provider: productDetails.provider,
                presentation: productDetails.presentation,
                newStock: newStock,
            };
            movementHistory.push(movementRecord);
            saveMovements(); // Guardar historial

            // 3. Actualizar Inventario y Guardar
            currentInventory[itemIndex].stock = newStock;
            saveInventory();
            renderInventoryList();

            // 4. Mensaje de éxito
            showMessage(`¡${isEntry ? 'Entrada' : 'Salida'} de ${quantity} registrada con éxito!`, 'success');
            DOMElements.quantityInput.value = '1';
        }
        
        // --- RENDERIZADO DE INVENTARIO (Mantenido) ---

        function renderInventoryList() {
            const filterProvider = DOMElements.filterProvider.value;
            const filterText = DOMElements.filterProduct.value.toLowerCase();
            
            const filteredInventory = currentInventory.filter(item => {
                const providerMatch = !filterProvider || item.provider === filterProvider;
                const textMatch = !filterText || item.name.toLowerCase().includes(filterText) || item.id.toLowerCase().includes(filterText);
                return providerMatch && textMatch;
            }).sort((a, b) => 
                a.provider.localeCompare(b.provider) || a.name.localeCompare(b.name)
            );

            DOMElements.inventoryItems.innerHTML = '';
            DOMElements.totalProducts.textContent = filteredInventory.length;
            
            const hasResults = filteredInventory.length > 0;
            DOMElements.noResults.classList.toggle('hidden', hasResults);
            DOMElements.tableHeaders.classList.toggle('hidden', !hasResults);


            if (!hasResults) return;

            filteredInventory.forEach(item => {
                const stockColorClass = item.stock <= 5 && item.stock > 0 
                    ? 'text-orange-500 font-bold' 
                    : (item.stock === 0 ? 'text-red-600 font-bold' : 'text-gray-900 dark:text-gray-100');
                
                const itemHtml = `
                    <div class="grid grid-cols-12 gap-4 py-3 px-4 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors duration-150 rounded-lg sm:rounded-none">
                        <!-- Producto (Visible en Móvil y Desktop) -->
                        <div class="col-span-12 sm:col-span-4 flex flex-col">
                            <span class="font-medium text-gray-800 dark:text-gray-200">${item.name}</span>
                            <span class="text-xs text-gray-400 dark:text-gray-500">Ref: ${item.id}</span>
                        </div>

                        <!-- Proveedor (Visible en Móvil y Desktop) -->
                        <div class="col-span-6 sm:col-span-2 text-sm text-gray-600 dark:text-gray-400 sm:self-center">
                            <span class="sm:hidden font-semibold text-gray-500 dark:text-gray-500 mr-2">Proveedor: </span>${item.provider}
                        </div>
                        
                        <!-- Presentación (Visible en Móvil y Desktop) -->
                        <div class="col-span-6 sm:col-span-3 text-sm text-gray-600 dark:text-gray-400 sm:self-center">
                            <span class="sm:hidden font-semibold text-gray-500 dark:text-gray-500 mr-2">Presentación: </span>${item.presentation}
                        </div>

                        <!-- Stock Actual (Visible en Móvil y Desktop) -->
                        <div class="col-span-12 sm:col-span-3 text-right text-lg sm:text-base font-extrabold ${stockColorClass} mt-2 sm:mt-0 sm:self-center">
                            <span class="sm:hidden font-semibold text-gray-500 dark:text-gray-500 mr-2">Stock: </span>${item.stock} unidades
                        </div>
                    </div>
                `;
                DOMElements.inventoryItems.insertAdjacentHTML('beforeend', itemHtml);
            });
        }
        
        // --- GESTIÓN DE UI / ESTADO (Mantenido) ---

        function showMessage(text, type, target = DOMElements.messageBox) {
            target.textContent = text;
            target.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800', 'dark:bg-red-900', 'dark:text-red-200', 'dark:bg-green-900', 'dark:text-green-200');
            
            if (type === 'error') {
                target.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-900', 'dark:text-red-200');
            } else if (type === 'success') {
                target.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-900', 'dark:text-green-200');
            } else if (type === 'info') {
                target.classList.add('bg-blue-100', 'text-blue-800', 'dark:bg-blue-900', 'dark:text-blue-200');
            }
            
            setTimeout(() => {
                target.classList.add('hidden');
            }, 5000);
        }

        function showMovementForm(type) {
            const isEntry = type === 'entrada';
            
            DOMElements.movementTypeInput.value = type;

            const activeClasses = ['border-green-600', 'dark:border-green-400', 'text-green-600', 'dark:text-green-400'];
            const inactiveClasses = ['border-transparent', 'text-gray-500', 'dark:text-gray-400'];
            const hoverClasses = ['hover:border-green-300', 'dark:hover:border-green-400', 'hover:text-green-600', 'dark:hover:text-green-400'];

            DOMElements.tabEntrada.classList.toggle('border-b-2', true); 
            DOMElements.tabSalida.classList.toggle('border-b-2', true); 

            activeClasses.forEach(cls => {
                DOMElements.tabEntrada.classList.toggle(cls, isEntry);
                DOMElements.tabSalida.classList.toggle(cls, !isEntry);
            });
            inactiveClasses.forEach(cls => {
                DOMElements.tabEntrada.classList.toggle(cls, !isEntry);
                DOMElements.tabSalida.classList.toggle(cls, isEntry);
            });
            hoverClasses.forEach(cls => {
                DOMElements.tabEntrada.classList.toggle(cls, !isEntry);
                DOMElements.tabSalida.classList.toggle(cls, isEntry);
            });

            // Actualizar botón de envío
            DOMElements.submitButton.innerHTML = `<i class="fas fa-${isEntry ? 'plus' : 'minus'} mr-2"></i> Registrar ${isEntry ? 'Entrada' : 'Salida'}`;
            DOMElements.submitButton.classList.toggle('btn-primary', isEntry);
            DOMElements.submitButton.classList.toggle('bg-red-600', !isEntry);
            DOMElements.submitButton.classList.toggle('hover:bg-red-700', !isEntry);
            DOMElements.submitButton.classList.toggle('bg-green-600', isEntry);
            DOMElements.submitButton.classList.toggle('hover:bg-green-700', isEntry);
        }

        // --- EXPORTACIÓN A CSV (NUEVA FUNCIÓN) ---
        
        /**
         * Maneja el formulario de exportación y genera el archivo CSV.
         */
        function handleExport(e) {
            e.preventDefault();

            const startDate = DOMElements.startDateInput.value;
            const endDate = DOMElements.endDateInput.value;
            
            if (!startDate || !endDate) {
                showMessage('Debes seleccionar una Fecha de Inicio y una Fecha de Fin.', 'error', DOMElements.exportMessage);
                return;
            }

            // Convertir fechas a objetos Date para comparación (se añade el final del día a endDate)
            const startTimestamp = new Date(startDate).getTime();
            const endTimestamp = new Date(endDate + 'T23:59:59').getTime(); // Asegura incluir todo el día final

            if (startTimestamp > endTimestamp) {
                showMessage('La fecha de inicio no puede ser posterior a la fecha de fin.', 'error', DOMElements.exportMessage);
                return;
            }

            // 1. Filtrar Movimientos
            const filteredMovements = movementHistory.filter(record => {
                const recordTimestamp = new Date(record.date).getTime();
                return recordTimestamp >= startTimestamp && recordTimestamp <= endTimestamp;
            });

            if (filteredMovements.length === 0) {
                showMessage('No se encontraron movimientos en el rango de fechas seleccionado.', 'info', DOMElements.exportMessage);
                return;
            }

            // 2. Preparar el contenido CSV
            const csvContent = convertToCSV(filteredMovements);

            // 3. Crear y descargar el archivo
            const today = new Date().toISOString().slice(0, 10);
            const filename = `Reporte_Movimientos_Agropiragua_${startDate}_a_${endDate}_${today}.csv`;
            downloadCSV(csvContent, filename);

            showMessage(`Exportados ${filteredMovements.length} movimientos al archivo "${filename}".`, 'success', DOMElements.exportMessage);
        }

        /**
         * Convierte un array de objetos a una cadena de texto en formato CSV.
         */
        function convertToCSV(data) {
            // Cabeceras en español
            const headers = [
                "FECHA_HORA", 
                "TIPO_MOVIMIENTO", 
                "CANTIDAD", 
                "PRODUCTO_ID", 
                "PRODUCTO_NOMBRE", 
                "PROVEEDOR", 
                "PRESENTACION", 
                "STOCK_RESULTANTE"
            ];
            
            // Mapeo de claves a usar
            const keys = ["date", "type", "quantity", "productId", "productName", "provider", "presentation", "newStock"];

            let csv = headers.join(";") + "\n"; // Usamos punto y coma (;) como separador para compatibilidad con Excel en muchos países

            data.forEach(item => {
                const row = keys.map(key => {
                    let value = item[key];
                    if (key === 'date') {
                        // Formatear la fecha/hora para mejor legibilidad
                        value = new Date(value).toLocaleString('es-CO');
                    } else if (typeof value === 'string') {
                        // Escapar comillas dobles y asegurarse de que no haya saltos de línea
                        value = `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                }).join(";");
                csv += row + "\n";
            });

            return csv;
        }

        /**
         * Crea un blob de datos CSV y dispara la descarga.
         */
        function downloadCSV(csvContent, filename) {
            // El '\ufeff' es el BOM (Byte Order Mark) que le dice a Excel que el archivo está en UTF-8
            const blob = new Blob(['\ufeff', csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            
            // Compatibilidad de navegadores
            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
        }

        // --- INICIALIZACIÓN PRINCIPAL ---
        
        window.onload = function() {
            // 1. Inicializar Modo Oscuro
            initializeDarkMode();
            DOMElements.darkModeToggle.addEventListener('click', toggleDarkMode);

            // 2. Cargar/Inicializar Inventario y Movimientos desde LocalStorage
            initializeData();

            // 3. Poblar los selectores de la UI
            populateSelectors();

            // 4. Configurar listeners de la UI
            DOMElements.movementForm.addEventListener('submit', registerMovement);
            DOMElements.filterProvider.addEventListener('change', renderInventoryList);
            DOMElements.filterProduct.addEventListener('input', renderInventoryList);
            DOMElements.exportForm.addEventListener('submit', handleExport); // NUEVO: Listener para Exportar
            
            // Listeners para las pestañas de movimiento
            DOMElements.tabEntrada.addEventListener('click', () => showMovementForm('entrada'));
            DOMElements.tabSalida.addEventListener('click', () => showMovementForm('salida'));
            
            // 5. Inicializar estado y renderizado
            showMovementForm('entrada');
            renderInventoryList();
            
            // Establecer fechas por defecto para el reporte (últimos 30 días)
            const today = new Date();
            const lastMonth = new Date();
            lastMonth.setDate(today.getDate() - 30);

            const formatDate = (date) => date.toISOString().slice(0, 10);
            
            DOMElements.startDateInput.value = formatDate(lastMonth);
            DOMElements.endDateInput.value = formatDate(today);
        };

    </script>
</body>
</html>
